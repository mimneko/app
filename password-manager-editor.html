<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>パスワード管理</title>
    <script type="application/json" id="password-data">
    {
        "accounts": [
            {
                "account": "Amazon",
                "registrationDate": "2023-01-15",
                "status": "現役",
                "target": "個人",
                "username": "taro_yamada",
                "email": "taro.yamada@example.com",
                "password": "AmzSecure!2023",
                "customData": [
                    {"label": "プライム会員", "value": "有効", "id": "cd1a2b3c"},
                    {"label": "配送先", "value": "自宅", "id": "cd4d5e6f"}
                ],
                "lastName": "山田",
                "firstName": "太郎",
                "birthdate": "1990-05-20",
                "gender": "男性",
                "phone": "090-1234-5678",
                "postalCode": "160-0023",
                "country": "日本",
                "prefecture": "東京都",
                "address": "新宿区西新宿2-8-1",
                "notes": [
                    {"date": "2023-01-15", "content": "アカウント作成", "visible": true},
                    {"date": "2023-05-10", "content": "パスワード変更", "visible": true}
                ],
                "id": "a1b2c3d4"
            },
            {
                "account": "楽天",
                "registrationDate": "2022-12-01",
                "status": "現役",
                "target": "個人",
                "username": "yamada_taro",
                "email": "yamada.taro@rakuten.com",
                "password": "Rktn!2022Secure",
                "customData": [
                    {"label": "ポイント会員", "value": "ゴールド", "id": "cd7g8h9i"}
                ],
                "lastName": "山田",
                "firstName": "太郎",
                "birthdate": "1990-05-20",
                "gender": "男性",
                "phone": "090-1234-5678",
                "postalCode": "160-0023",
                "country": "日本",
                "prefecture": "東京都",
                "address": "新宿区西新宿2-8-1",
                "notes": [
                    {"date": "2022-12-01", "content": "アカウント作成", "visible": false},
                    {"date": "2023-04-15", "content": "ポイント更新", "visible": true}
                ],
                "id": "m3n4o5p6"
            },
            {
                "account": "Google",
                "registrationDate": "2022-11-20",
                "status": "現役",
                "target": "家族",
                "username": "hanako.family",
                "email": "hanako.family@gmail.com",
                "password": "GglFamily!2022",
                "customData": [],
                "lastName": "山田",
                "firstName": "花子",
                "birthdate": "1985-08-15",
                "gender": "女性",
                "phone": "090-8765-4321",
                "postalCode": "160-0023",
                "country": "日本",
                "prefecture": "東京都",
                "address": "新宿区西新宿2-8-1",
                "notes": [
                    {"date": "2022-11-20", "content": "家族用アカウント作成", "visible": false},
                    {"date": "2023-03-15", "content": "セキュリティ設定確認", "visible": true},
                    {"date": "2023-07-01", "content": "二段階認証設定", "visible": true}
                ],
                "id": "e5f6g7h8"
            },
            {
                "account": "Twitter",
                "registrationDate": "2021-06-10",
                "status": "退会",
                "target": "個人",
                "username": "taro_tweet",
                "email": "taro.tweet@example.com",
                "password": "TwtrSecure!2021",
                "customData": [],
                "lastName": "山田",
                "firstName": "太郎",
                "birthdate": "1990-05-20",
                "gender": "男性",
                "phone": "090-1234-5678",
                "postalCode": "160-0023",
                "country": "日本",
                "prefecture": "東京都",
                "address": "新宿区西新宿2-8-1",
                "notes": [
                    {"date": "2021-06-10", "content": "アカウント作成", "visible": false},
                    {"date": "2022-12-05", "content": "アカウント休止", "visible": true}
                ],
                "id": "i9j0k1l2"
            },
            {
                "account": "Google",
                "registrationDate": "2022-11-20",
                "status": "現役",
                "target": "家族",
                "username": "hanako.family",
                "email": "hanako.family@gmail.com",
                "password": "GglSecure!2022",
                "customData": [
                    {"label": "ストレージプラン", "value": "100GB", "id": "cd0j1k2l"},
                    {"label": "バックアップ", "value": "有効", "id": "cd3m4n5o"}
                ],
                "lastName": "山田",
                "firstName": "花子",
                "birthdate": "1985-08-15",
                "gender": "女性",
                "phone": "090-8765-4321",
                "postalCode": "160-0023",
                "country": "日本",
                "prefecture": "東京都",
                "address": "新宿区西新宿2-8-1",
                "notes": [
                    {"date": "2022-11-20", "content": "家族用アカウント作成", "visible": false},
                    {"date": "2023-03-15", "content": "セキュリティ設定確認", "visible": true},
                    {"date": "2023-07-01", "content": "二段階認証設定", "visible": false}
                ],
                "id": "q7r8s9t0"
            }
        ]
    }
    </script>
    <style>
        /* 全体のスタイル */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic Medium", "Hiragino Sans", "Meiryo", "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            padding-top: 120px;
        }

        button {
            color: white;
        }
        
        /* フィルター部分 */
        .filters {
            background-color: #fff;
            padding: 15px;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex-grow: 1;
        }
        
        .filter-group label {
            font-weight: bold;
            font-size: 0.9rem;
            color: #666;
        }
        
        .filters input, .filters select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .reset-btn {
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            font-weight: bold;
            align-self: flex-end;
            transition: background-color 0.2s;
        }
        
        .reset-btn:hover {
            background-color: #d32f2f;
        }
        
        /* カード表示（共通） */
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px;
        }
        
        /* 大画面向けカード表示 */
        @media (min-width: 1200px) {
            .card-container {
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            }
        }
        
        /* 小さい画面向けカード表示 */
        @media (max-width: 768px) {
            .card-container {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
                padding: 10px;
            }
            
            .filter-group {
                width: 100%;
            }
            
            body {
                padding-top: 210px;
            }

            .filter-group:has(> #filter-status),
            .filter-group:has(> #filter-target),
            .filter-group:has(> #filter-email),
            #reset-filters {
                display: none;
            }
            
            .info {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
        
        .card {
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .card-header {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .service-name {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .card-header-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .registration-date {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .card-content {
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px 15px;
        }
        
        .card-group {
            margin-bottom: 10px;
        }
        
        .card-group.full-width {
            grid-column: 1 / -1;
        }
        
        .card-label {
            font-weight: bold;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
            display: block;
        }
        
        .card-value {
            padding: 8px;
            background-color: #f9f9f9;
            border-radius: 4px;
            word-break: break-all;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .card-value:hover {
            background-color: #f0f7ff;
        }
        
        .card-value.copied {
            background-color: #e3f2fd;
        }
        
        .notes-container {
            grid-column: 1 / -1;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        
        .note-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #eee;
        }
        
        .note-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .note-date {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 3px;
        }
        
        /* 編集用備考スタイル */
        .edit-note-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .edit-note-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .edit-note-item input.edit-note-date {
            width: 150px;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .edit-note-item textarea.edit-note-content {
            width: 100%;
            min-height: 40px;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            resize: vertical;
        }
        .edit-note-item button {
            margin-right: 5px;
            align-self: flex-end;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        /* 編集用カスタムデータスタイル */
        .edit-custom-data-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .edit-custom-data-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .edit-custom-data-item input.edit-custom-data-label,
        .edit-custom-data-item input.edit-custom-data-value {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .edit-custom-data-item button {
            margin-right: 5px;
            align-self: flex-end;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
            white-space: nowrap; /* Prevents text from wrapping */
        }
        
        /* コピー通知 */
        .copy-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        
        .copy-notification.show {
            opacity: 1;
        }
        
        /* 検索結果と並び替え */
        .info {
            margin: 0 20px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-count {
            color: #666;
            font-size: 0.9rem;
            text-align: right;
        }
        
        .sort-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sort-controls span {
            color: #666;
            font-size: 0.9rem;
        }
        
        .sort-btn {
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }
        
        .sort-btn:hover {
            background-color: #1a252f;
        }
        
        .sort-btn.active {
            background-color: #1a252f;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* 詳細情報表示 */
        .card-content > details {
            grid-column: 1 / -1;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        
        details summary {
            cursor: pointer;
            font-weight: bold;
            color: #2c3e50;
            padding: 5px 0;
            transition: color 0.2s;
        }
        
        details summary:hover {
            color: #1a252f;
        }
        
        .details-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px 15px;
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        
        .details-content .card-group.full-width {
            grid-column: 1 / -1;
        }

        /* アクションボタン */
        .action-buttons {
            display: flex;
            gap: 20px;
            margin-right: auto;
        }
        
        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn-add {
            background-color: #4caf50;
        }
        
        .btn-add:hover {
            background-color: #3e8e41;
        }
        
        .btn-export {
            background-color: #2196f3!important;
        }
        
        .btn-export:hover {
            background-color: #0b7dda!important;
        }
        
        .btn-edit {
            background-color: #ff9800;
        }
        
        .btn-edit:hover {
            background-color: #e68900;
        }
        
        .btn-delete {
            background-color: #f44336;
        }
        
        .btn-delete:hover {
            background-color: #d32f2f;
        }
        
        /* アカウント追加モーダル */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 0;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 80%;
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
            background-color: #fff;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .modal-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .close-modal {
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            color: #666;
        }
        
        .close-modal:hover {
            color: #000;
        }
        
        .form-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 20px;
            overflow-y: auto;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-group label {
            font-weight: bold;
            font-size: 0.9rem;
            color: #666;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            font-family: "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic Medium", "Hiragino Sans", "Meiryo", "Helvetica Neue", Arial, sans-serif;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .submit-btn {
            grid-column: 1 / -1;
            background-color: #ff9800;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 10px;
        }
        
        .submit-btn:hover {
            background-color: #e68900;
        }
        
        /* カード選択 */
        .card.selected {
            border: 2px solid #2196f3;
        }
        
        .select-checkbox {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 20px;
            height: 20px;
        }
        
        /* 新規追加・編集モーダルの個人情報欄を2列レイアウトにする */
        .personal-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        #edit-details-personal,
        #new-details-personal,
        .personal-info-grid .form-group.full-width {
            grid-column: 1 / -1;
        }

        .hidden-note-indicator {
            font-size: small;
            text-align: right;
        }

        .delete-note-btn {
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            margin-left: auto;
            cursor: pointer;
            font-weight: bold;
            align-self: flex-end;
            transition: background-color 0.2s;
        }
        
        .delete-note-btn:hover {
            background-color: #d32f2f;
        }
        
        /* Toggle Switch for Edit Notes */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin: 0 10px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-switch .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .toggle-switch .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        .toggle-switch input:checked + .slider {
            background-color: #2196F3;
        }
        .toggle-switch input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }
        .toggle-switch input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .highlighted {
            background-color: #ff9800!important;
            border-color: #ff9800!important;
        }

        #edit-custom-data-group,
        #edit-notes-group {
            padding: 15px 0;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }

        @media print {
            .filters,
            .info,
            .action-buttons,
            .withdrawn-account,
            .edit-btn,
            details,
            .hidden-note-indicator,
            .btn-edit {
                display: none;
            }

            body {
                background-color: transparent;
                padding: 0;
            }

            .card-header {
                background-color: transparent;
                color: #000;
                border-bottom: 1px solid #000;
            }

            .card {
                background-color: transparent;
                border: 2px solid #000;
                box-shadow: none;
            }

            .card-value {
                background-color: transparent;
                border: 1px solid #000;
            }

            .notes-container {
                border-top: 1px solid #000;
            }

            .note-item {
                padding-bottom: 0;
                border-bottom: none;
            }
        }
    </style>
</head>
<body>
    <section class="filters">
        <div class="filter-group">
            <label for="search-account">サービス検索</label>
            <input type="text" id="search-account" placeholder="サービス名を入力">
        </div>
        
        <div class="filter-group">
            <label for="filter-status">状況</label>
            <select id="filter-status">
                <option value="退会以外" selected>退会以外</option>
                <option value="すべて">すべて</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="filter-target">対象</label>
            <select id="filter-target">
                <option value="">すべて</option>
                <!-- 対象オプションはJSで動的に追加 -->
            </select>
        </div>
        
        <div class="filter-group">
            <label for="filter-email">メールアドレス</label>
            <select id="filter-email">
                <option value="">すべて</option>
                <!-- メールアドレスオプションはJSで動的に追加 -->
            </select>
        </div>
        
        <div class="filter-group">
            <span class="result-count" id="result-count"></span>
            <button class="reset-btn btn-delete" id="reset-filters">リセット</button>
        </div>
        
        <div class="filter-group">
            <button id="add-account" class="action-btn btn-add">アカウント追加</button>
            <button id="export-json" class="action-btn btn-export">JSONエクスポート</button>
        </div>
    </section>
<!--
    <div class="info">
        <div class="action-buttons">
            <button id="add-account" class="action-btn btn-add">アカウント追加</button>
            <button id="export-json" class="action-btn btn-export">JSONエクスポート</button>
        </div>
    </div>
-->        
    <!-- カード表示 -->
    <div class="card-container" id="card-container">
        <!-- JSで動的に追加 -->
    </div>
    
    <!-- アカウント追加モーダル -->
    <div id="add-account-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">新しいアカウントを追加</h3>
                <span class="close-modal" id="close-add-modal">&times;</span>
            </div>
            <form id="add-account-form" class="form-container">
                <div class="form-group full-width">
                    <label for="new-account">サービス名*</label>
                    <input type="text" id="new-account" required placeholder="Amazon, Google など">
                </div>
                <div class="form-group">
                    <label for="new-status">状況*</label>
                    <select id="new-status" required>
                        <option value="現役">現役</option>
                        <option value="放置">放置</option>
                        <option value="退会">退会</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-target">対象*</label>
                    <input type="text" id="new-target" required placeholder="個人、家族 など" list="target-options">
                    <datalist id="target-options"></datalist>
                </div>
                <div class="form-group">
                    <label for="new-username">ユーザー（アカウント）名</label>
                    <input type="text" id="new-username" placeholder="user123 など">
                </div>
                <div class="form-group">
                    <label for="new-email">メールアドレス</label>
                    <input type="email" id="new-email" placeholder="example@email.com" list="email-options">
                    <datalist id="email-options"></datalist>
                </div>
                <div class="form-group">
                    <label for="new-password">パスワード</label>
                    <input type="text" id="new-password" placeholder="パスワード">
                </div>
                <div class="form-group full-width" id="new-custom-data-group">
                    <div id="new-custom-data-container"></div>
                    <button type="button" id="add-new-custom-data" class="action-btn btn-add">カスタムデータ追加</button>
                </div>
                <details id="new-details-personal">
                    <summary>個人情報</summary>
                    <div class="personal-info-grid">
                        <div class="form-group">
                            <label for="new-lastname">姓LastName</label>
                            <input type="text" id="new-lastname" placeholder="山田">
                        </div>
                        <div class="form-group">
                            <label for="new-firstname">名FirstName</label>
                            <input type="text" id="new-firstname" placeholder="太郎">
                        </div>
                        <div class="form-group">
                            <label for="new-birthdate">生年月日</label>
                            <input type="date" id="new-birthdate">
                        </div>
                        <div class="form-group">
                            <label for="new-gender">性別</label>
                            <select id="new-gender">
                                <option value="">選択なし</option>
                                <option value="男性">男性</option>
                                <option value="女性">女性</option>
                                <option value="その他">その他</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="new-phone">電話番号</label>
                            <input type="tel" id="new-phone" placeholder="090-1234-5678">
                        </div>
                        <div class="form-group">
                            <label for="new-postalcode">郵便番号</label>
                            <input type="text" id="new-postalcode" placeholder="123-4567">
                        </div>
                        <div class="form-group">
                            <label for="new-country">国</label>
                            <input type="text" id="new-country" placeholder="日本">
                        </div>
                        <div class="form-group">
                            <label for="new-prefecture">都道府県</label>
                            <input type="text" id="new-prefecture" placeholder="東京都">
                        </div>
                        <div class="form-group full-width">
                            <label for="new-address">住所</label>
                            <input type="text" id="new-address" placeholder="新宿区西新宿1-1-1">
                        </div>
                    </div>
                </details>
                <div class="form-group full-width">
                    <button type="button" id="fill-default-personal-add" class="submit-btn btn-export">固定個人情報入力</button>
                </div>
                <div class="form-group full-width">
                    <label for="new-note">備考</label>
                    <textarea id="new-note" placeholder="備考を入力してください"></textarea>
                </div>
                <button type="submit" class="submit-btn">アカウントを追加</button>
            </form>
        </div>
    </div>
    
    <!-- アカウント編集モーダル -->
    <div id="edit-account-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">アカウント編集</h3>
                <span class="close-modal" id="close-edit-modal">&times;</span>
            </div>
            <form id="edit-account-form" class="form-container">
                <div class="form-group full-width">
                    <label for="edit-account">サービス名*</label>
                    <input type="text" id="edit-account" required placeholder="Amazon, Google など">
                </div>
                <div class="form-group">
                    <label for="edit-status">状況*</label>
                    <select id="edit-status" required>
                        <option value="現役">現役</option>
                        <option value="放置">放置</option>
                        <option value="退会">退会</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-target">対象*</label>
                    <input type="text" id="edit-target" required placeholder="個人、家族 など" list="target-options">
                </div>
                <div class="form-group">
                    <label for="edit-username">ユーザー（アカウント）名</label>
                    <input type="text" id="edit-username" placeholder="user123 など">
                </div>
                <div class="form-group">
                    <label for="edit-email">メールアドレス</label>
                    <input type="email" id="edit-email" placeholder="example@email.com" list="email-options">
                </div>
                <div class="form-group">
                    <label for="edit-password">パスワード</label>
                    <input type="text" id="edit-password" placeholder="パスワード">
                </div>
                <div class="form-group full-width" id="edit-custom-data-group">
                    <div id="edit-custom-data-container"></div>
                    <button type="button" id="add-edit-custom-data" class="action-btn btn-add">カスタムデータ追加</button>
                </div>
                <details id="edit-details-personal">
                    <summary>個人情報</summary>
                    <div class="personal-info-grid">
                        <div class="form-group">
                            <label for="edit-lastname">姓LastName</label>
                            <input type="text" id="edit-lastname" placeholder="山田">
                        </div>
                        <div class="form-group">
                            <label for="edit-firstname">名FirstName</label>
                            <input type="text" id="edit-firstname" placeholder="太郎">
                        </div>
                        <div class="form-group">
                            <label for="edit-birthdate">生年月日</label>
                            <input type="date" id="edit-birthdate">
                        </div>
                        <div class="form-group">
                            <label for="edit-gender">性別</label>
                            <select id="edit-gender">
                                <option value="">選択なし</option>
                                <option value="男性">男性</option>
                                <option value="女性">女性</option>
                                <option value="その他">その他</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-phone">電話番号</label>
                            <input type="tel" id="edit-phone" placeholder="090-1234-5678">
                        </div>
                        <div class="form-group">
                            <label for="edit-postalcode">郵便番号</label>
                            <input type="text" id="edit-postalcode" placeholder="123-4567">
                        </div>
                        <div class="form-group">
                            <label for="edit-country">国</label>
                            <input type="text" id="edit-country" placeholder="日本">
                        </div>
                        <div class="form-group">
                            <label for="edit-prefecture">都道府県</label>
                            <input type="text" id="edit-prefecture" placeholder="東京都">
                        </div>
                        <div class="form-group full-width">
                            <label for="edit-address">住所</label>
                            <input type="text" id="edit-address" placeholder="新宿区西新宿1-1-1">
                        </div>
                    </div>
                </details>
                <!-- 備考編集エリア：複数のノートを表示し、各ノートはトグルスイッチで表示/非表示を切り替え可能 -->
                <div class="form-group full-width" id="edit-notes-group">
                    <div id="edit-notes-container"></div>
                    <button type="button" id="add-edit-note" class="action-btn btn-add">備考を追加</button>
                </div>
                <button type="submit" class="submit-btn">アカウントを更新</button>
            </form>
        </div>
    </div>
    
    <div class="copy-notification" id="copy-notification">
        クリップボードにコピーしました
    </div>
    
    <script>
        // データ読み込み
        const passwordData = JSON.parse(document.getElementById('password-data').textContent);
        let accounts = passwordData.accounts;
        
        // DOM要素の参照
        const cardContainer = document.getElementById('card-container');
        const searchAccount = document.getElementById('search-account');
        const filterStatus = document.getElementById('filter-status');
        const filterTarget = document.getElementById('filter-target');
        const filterEmail = document.getElementById('filter-email');
        const copyNotification = document.getElementById('copy-notification');
        const resetFiltersBtn = document.getElementById('reset-filters');
        const resultCount = document.getElementById('result-count');
        
        // フィルターオプションの初期設定
        function setupFilterOptions() {
            const targetFreq = {};
            const emailFreq = {};
            
            accounts.forEach(account => {
                const target = account.target || "";
                const email = account.email || "";
                if(target) targetFreq[target] = (targetFreq[target] || 0) + 1;
                if(email) emailFreq[email] = (emailFreq[email] || 0) + 1;
            });
            
            updateFilterOptions(filterTarget, targetFreq);
            updateFilterOptions(filterEmail, emailFreq);
            updateDatalist('target-options', targetFreq);
            updateDatalist('email-options', emailFreq);
        }

        function updateFilterOptions(filterElement, frequencyData) {
            const sortedKeys = Object.keys(frequencyData).sort((a, b) => frequencyData[b] - frequencyData[a]);
            filterElement.innerHTML = '<option value="">すべて</option>';
            sortedKeys.forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = key;
                filterElement.appendChild(option);
            });
        }

        function updateDatalist(datalistId, frequencyData) {
            const datalist = document.getElementById(datalistId);
            if (datalist) {
                datalist.innerHTML = '';
                Object.keys(frequencyData).forEach(key => {
                    const opt = document.createElement('option');
                    opt.value = key;
                    datalist.appendChild(opt);
                });
            }
        }
        
        // データ表示（カード）
        function renderData(data) {
            cardContainer.innerHTML = '';
            resultCount.textContent = `検索結果: ${data.length}/${accounts.length} 件`;
            
            data.forEach(account => {
                const card = createCard(account);
                cardContainer.appendChild(card);
            });
        }

        function createCard(account) {
            const card = document.createElement('div');
            card.className = 'card';
            card.classList.add(getStatusClass(account.status));

            const header = createCardHeader(account);
            card.appendChild(header);

            const content = createCardContent(account);
            card.appendChild(content);

            return card;
        }

        function getStatusClass(status) {
            switch (status) {
                case '現役': return 'active-account';
                case '放置': return 'inactive-account';
                case '退会': return 'withdrawn-account';
                default: return 'unknown-account';
            }
        }

        function createCardHeader(account) {
            const header = document.createElement('div');
            header.className = 'card-header';

            const serviceName = document.createElement('span');
            serviceName.className = 'service-name';
            serviceName.textContent = account.account;
            header.appendChild(serviceName);

            const headerInfo = document.createElement('div');
            headerInfo.className = 'card-header-info';

            const registrationDate = document.createElement('span');
            registrationDate.className = 'registration-date';
            registrationDate.textContent = account.registrationDate || '記録なし';
            headerInfo.appendChild(registrationDate);

            header.appendChild(headerInfo);

            const editBtn = document.createElement('button');
            editBtn.className = 'action-btn btn-edit';
            editBtn.textContent = '編集';
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                openEditModal(account);
            });
            header.appendChild(editBtn);

            return header;
        }

        function createCardContent(account) {
            const content = document.createElement('div');
            content.className = 'card-content';

            addNonCopyableCardItem(content, '状況', account.status);
            addNonCopyableCardItem(content, '対象', account.target);
            addCardItem(content, 'メールアドレス', account.email);
            addCardItem(content, 'パスワード', account.password);
            addCardItem(content, 'ユーザー（アカウント）名', account.username);

            if (account.customData && account.customData.length > 0) {
                account.customData.forEach(data => {
                    addCardItem(content, data.label, data.value);
                });
            }

            if (hasPersonalInfo(account)) {
                const details = createDetails(account);
                content.appendChild(details);
            }

            const notesContainer = createNotesContainer(account.notes);
            if (notesContainer) {
                content.appendChild(notesContainer);
            }

            return content;
        }

        function hasPersonalInfo(account) {
            return account.lastName || account.firstName || account.birthdate || account.gender || account.phone || account.postalCode || account.country || account.prefecture || account.address;
        }

        function createDetails(account) {
            const details = document.createElement('details');
            const summary = document.createElement('summary');
            summary.textContent = '個人情報';
            details.appendChild(summary);

            const detailsContent = document.createElement('div');
            detailsContent.className = 'details-content';

            addCardItem(detailsContent, '姓LastName', account.lastName);
            addCardItem(detailsContent, '名FirstName', account.firstName);
            addCardItem(detailsContent, '生年月日', account.birthdate);
            addCardItem(detailsContent, '性別', account.gender);
            addCardItem(detailsContent, '電話番号', account.phone);
            addCardItem(detailsContent, '郵便番号', account.postalCode);
            addCardItem(detailsContent, '国', account.country);
            addCardItem(detailsContent, '都道府県', account.prefecture);

            const addressGroup = document.createElement('div');
            addressGroup.className = 'card-group full-width';

            const addressLabel = document.createElement('div');
            addressLabel.className = 'card-label';
            addressLabel.textContent = '住所';

            const addressValue = document.createElement('div');
            addressValue.className = 'card-value';
            addressValue.textContent = account.address || '';
            addressValue.addEventListener('click', (e) => handleCopy(e, account.address || ''));

            addressGroup.appendChild(addressLabel);
            addressGroup.appendChild(addressValue);
            detailsContent.appendChild(addressGroup);

            details.appendChild(detailsContent);
            return details;
        }

        function createNotesContainer(notes) {
            if (!notes || notes.length === 0) {
                return null;
            }

            const notesContainer = document.createElement('div');
            notesContainer.className = 'notes-container';

            const notesLabel = document.createElement('div');
            notesLabel.className = 'card-label';
            notesContainer.appendChild(notesLabel);

            const visibleNotes = notes.filter(note => note.visible !== false);
            const hiddenNotes = notes.filter(note => note.visible === false);

            if (visibleNotes.length > 0) {
                const sortedNotes = [...visibleNotes].sort((a, b) => new Date(a.date) - new Date(b.date));
                sortedNotes.forEach(note => {
                    const noteItem = document.createElement('div');
                    noteItem.className = 'note-item';

                    const dateDiv = document.createElement('div');
                    dateDiv.className = 'note-date';
                    dateDiv.textContent = note.date;

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'card-value';
                    contentDiv.textContent = note.content;
                    contentDiv.addEventListener('click', (e) => handleCopy(e, note.content));

                    noteItem.appendChild(dateDiv);
                    noteItem.appendChild(contentDiv);
                    notesContainer.appendChild(noteItem);
                });
            }

            if (hiddenNotes.length > 0) {
                const hiddenNoteIndicator = document.createElement('div');
                hiddenNoteIndicator.className = 'hidden-note-indicator';
                hiddenNoteIndicator.textContent = `非表示の備考: ${hiddenNotes.length} 件`;
                notesContainer.appendChild(hiddenNoteIndicator);
            }

            return notesContainer;
        }
        
        // カード項目作成ヘルパー
        function addCardItem(container, label, value) {
            if (!value) return;
            const group = document.createElement('div');
            group.className = 'card-group';
            
            const labelElement = document.createElement('div');
            labelElement.className = 'card-label';
            labelElement.textContent = label;
            
            const valueElement = document.createElement('div');
            valueElement.className = 'card-value';
            valueElement.textContent = value;
            valueElement.addEventListener('click', (e) => handleCopy(e, value));
            
            group.appendChild(labelElement);
            group.appendChild(valueElement);
            container.appendChild(group);
        }

        // 非コピー可能なカード項目作成ヘルパー
        function addNonCopyableCardItem(container, label, value) {
            if (!value) return;
            const group = document.createElement('div');
            group.className = 'card-group';
            
            labelElement = document.createElement('div');
            labelElement.className = 'card-label';
            labelElement.textContent = `${label}：${value}`;
            
            group.appendChild(labelElement);
            container.appendChild(group);
        }
        
        // クリップボードにコピーとUI表示
        function handleCopy(event, text) {
            if (!text) return;
            
            const element = event.currentTarget;
            element.classList.add('copied');
            setTimeout(() => {
                element.classList.remove('copied');
            }, 1000);
            
            navigator.clipboard.writeText(text)
                .then(() => {
                    copyNotification.textContent = `「${text.substring(0, 20)}${text.length > 20 ? '...' : ''}」をコピーしました`;
                    copyNotification.classList.add('show');
                    setTimeout(() => {
                        copyNotification.classList.remove('show');
                    }, 2000);
                })
                .catch(err => {
                    console.error('クリップボードのコピーに失敗しました:', err);
                });
        }
        
        // 編集用備考項目を生成する関数
        function populateEditNotes(notes) {
            const container = document.getElementById('edit-notes-container');
            container.innerHTML = '';
            if (!notes || notes.length === 0) {
                notes = [];
            }
            notes.forEach((note, index) => {
                const noteItem = document.createElement('div');
                noteItem.className = 'edit-note-item';
                noteItem.setAttribute('data-visible', (note.visible === false ? "false" : "true"));
                
                const controls = document.createElement('div');
                controls.className = 'edit-note-controls';
                
                const dateInput = document.createElement('input');
                dateInput.type = 'date';
                dateInput.className = 'edit-note-date';
                dateInput.value = note.date || new Date().toISOString().split('T')[0];
                
                const toggleLabel = document.createElement('label');
                toggleLabel.className = 'toggle-switch';
                const toggleInput = document.createElement('input');
                toggleInput.type = 'checkbox';
                toggleInput.checked = note.visible !== false;
                toggleInput.addEventListener('change', function() {
                    noteItem.setAttribute('data-visible', toggleInput.checked ? "true" : "false");
                });
                const toggleSlider = document.createElement('span');
                toggleSlider.className = 'slider';
                toggleLabel.appendChild(toggleInput);
                toggleLabel.appendChild(toggleSlider);
                
                if (note.isNew) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'delete-note-btn btn-delete';
                    deleteBtn.textContent = '削除';
                    deleteBtn.addEventListener('click', function() {
                        container.removeChild(noteItem);
                    });
                    controls.appendChild(deleteBtn);
                }
                
                controls.appendChild(dateInput);
                controls.appendChild(toggleLabel);
                noteItem.appendChild(controls);
                
                const contentTextarea = document.createElement('textarea');
                contentTextarea.className = 'edit-note-content';
                contentTextarea.placeholder = '備考を入力してください';
                contentTextarea.value = note.content || '';

                noteItem.appendChild(contentTextarea);
                
                container.appendChild(noteItem);
            });
        }
        
        // 編集用カスタムデータ項目を生成する関数
        function populateEditCustomData(customData) {
            const container = document.getElementById('edit-custom-data-container');
            container.innerHTML = '';
            if (!customData || customData.length === 0) {
                customData = [];
            }
            customData.forEach((data, index) => {
                const dataItem = document.createElement('div');
                dataItem.className = 'edit-custom-data-item';
                
                const labelInput = document.createElement('input');
                labelInput.type = 'text';
                labelInput.className = 'edit-custom-data-label';
                labelInput.placeholder = 'ラベル名を入力';
                labelInput.value = data.label || '';
                labelInput.setAttribute('list', 'custom-label-options');

                const valueInput = document.createElement('input');
                valueInput.type = 'text';
                valueInput.className = 'edit-custom-data-value';
                valueInput.placeholder = '値を入力';
                valueInput.value = data.value || '';

                const controls = document.createElement('div');
                controls.className = 'edit-custom-data-controls';

                if (data.isNew) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'action-btn btn-delete';
                    deleteBtn.textContent = '削除';
                    deleteBtn.addEventListener('click', function() {
                        container.removeChild(dataItem);
                    });
                    controls.appendChild(deleteBtn);
                }

                controls.appendChild(labelInput);
                controls.appendChild(valueInput);
                dataItem.appendChild(controls);
                
                container.appendChild(dataItem);
            });
        }
        
        // フィルタリング処理
        function filterData() {
            const accountQuery = searchAccount.value.toLowerCase();
            const statusQuery = filterStatus.value;
            const targetQuery = filterTarget.value;
            const emailQuery = filterEmail.value;
            
            const filteredData = accounts.filter(account => {
                const accountMatch = account.account.toLowerCase().includes(accountQuery);
                let statusMatch = false;
                if (statusQuery === "すべて") {
                    statusMatch = true;
                } else if (statusQuery === "退会以外") {
                    statusMatch = account.status !== "退会";
                }
                const targetMatch = !targetQuery || account.target === targetQuery;
                const emailMatch = !emailQuery || account.email === emailQuery;
                
                return accountMatch && statusMatch && targetMatch && emailMatch;
            });
            
            renderData(filteredData);
        }
        
        // フィルターリセット
        function resetFilters() {
            searchAccount.value = '';
            filterStatus.value = '退会以外';
            filterTarget.value = '';
            filterEmail.value = '';
            filterData();
        }
                
        // アカウント追加・編集・JSONエクスポート機能
        function setupAccountManagement() {
            const addAccountBtn = document.getElementById('add-account');
            const exportJsonBtn = document.getElementById('export-json');
            const addAccountModal = document.getElementById('add-account-modal');
            const closeAddModalBtn = document.getElementById('close-add-modal');
            const addAccountForm = document.getElementById('add-account-form');
            
            const editAccountModal = document.getElementById('edit-account-modal');
            const closeEditModalBtn = document.getElementById('close-edit-modal');
            const editAccountForm = document.getElementById('edit-account-form');
            let currentEditingAccountId = null;
            
            addAccountBtn.addEventListener('click', () => {
                if (accounts.length >= 1024) {
                    showNotification('アカウントの上限に達しました。');
                    return;
                }
                addAccountModal.style.display = 'block';
                trackChanges('new');
                
                // Set the most frequent target as the default value for new accounts
                const targetOptions = document.getElementById('target-options').options;
                if (targetOptions.length > 0) {
                    document.getElementById('new-target').value = targetOptions[0].value;
                }
            });
            
            closeAddModalBtn.addEventListener('click', () => {
                if (isFormChanged('new') && confirm('本当に更新せずに閉じますか？')) {
                    addAccountModal.style.display = 'none';
                } else if (!isFormChanged('new')) {
                    addAccountModal.style.display = 'none';
                }
                resetFormStyles('new');
            });
            
            closeEditModalBtn.addEventListener('click', () => {
                if (isFormChanged('edit') && confirm('本当に更新せずに閉じますか？')) {
                    editAccountModal.style.display = 'none';
                } else if (!isFormChanged('edit')) {
                    editAccountModal.style.display = 'none';
                }
                resetFormStyles('edit');
            });
            
            window.addEventListener('click', (e) => {
                if (e.target === addAccountModal) {
                    if (isFormChanged('new') && confirm('本当に更新せずに閉じますか？')) {
                        addAccountModal.style.display = 'none';
                    } else if (!isFormChanged('new')) {
                        addAccountModal.style.display = 'none';
                    }
                    resetFormStyles('new');
                }
                if (e.target === editAccountModal) {
                    if (isFormChanged('edit') && confirm('本当に更新せずに閉じますか？')) {
                        editAccountModal.style.display = 'none';
                    } else if (!isFormChanged('edit')) {
                        editAccountModal.style.display = 'none';
                    }
                    resetFormStyles('edit');
                }
            });
            
            addAccountForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newId = generateRandomId();
                const today = new Date().toISOString().split('T')[0];
                
                const newAccount = {
                    id: newId,
                    account: document.getElementById('new-account').value,
                    status: document.getElementById('new-status').value,
                    target: document.getElementById('new-target').value,
                    email: document.getElementById('new-email').value,
                    password: document.getElementById('new-password').value,
                    registrationDate: today,
                    username: document.getElementById('new-username').value,
                    birthdate: document.getElementById('new-birthdate').value,
                    gender: document.getElementById('new-gender').value,
                    lastName: document.getElementById('new-lastname').value,
                    firstName: document.getElementById('new-firstname').value,
                    prefecture: document.getElementById('new-prefecture').value,
                    country: document.getElementById('new-country').value,
                    phone: document.getElementById('new-phone').value,
                    postalCode: document.getElementById('new-postalcode').value,
                    address: document.getElementById('new-address').value,
                    notes: [],
                    customData: []
                };
                
                const noteContent = document.getElementById('new-note').value;
                if (noteContent.trim() && newAccount.notes.length < 64) {
                    newAccount.notes.push({
                        date: today,
                        content: noteContent,
                        visible: true,
                        isNew: true
                    });
                }

                const customDataContainer = document.getElementById('new-custom-data-container');
                const customDataItems = customDataContainer.getElementsByClassName('edit-custom-data-item');
                for (const item of customDataItems) {
                    if (newAccount.customData.length >= 64) {
                        showNotification('カスタムデータの上限に達しました。');
                        break;
                    }
                    const labelVal = item.querySelector('.edit-custom-data-label').value;
                    const valueVal = item.querySelector('.edit-custom-data-value').value;
                    if(labelVal.trim() && valueVal.trim()){
                        newAccount.customData.push({
                            id: generateRandomId(),
                            label: labelVal,
                            value: valueVal,
                            isNew: true
                        });
                    }
                }
                
                accounts.push(newAccount);
                addAccountForm.reset();
                addAccountModal.style.display = 'none';
                setupFilterOptions();
                filterData();
                showNotification(`新しいアカウントを追加しました: ${newAccount.account}`);
                resetFormStyles('new');
            });
            
            function openEditModal(account) {
                currentEditingAccountId = account.id;
                document.getElementById('edit-account').value = account.account || '';
                document.getElementById('edit-status').value = account.status || '';
                document.getElementById('edit-target').value = account.target || '';
                document.getElementById('edit-email').value = account.email || '';
                document.getElementById('edit-password').value = account.password || '';
                document.getElementById('edit-username').value = account.username || '';
                document.getElementById('edit-birthdate').value = account.birthdate || '';
                document.getElementById('edit-gender').value = account.gender || '';
                document.getElementById('edit-lastname').value = account.lastName || '';
                document.getElementById('edit-firstname').value = account.firstName || '';
                document.getElementById('edit-prefecture').value = account.prefecture || '';
                document.getElementById('edit-country').value = account.country || '';
                document.getElementById('edit-phone').value = account.phone || '';
                document.getElementById('edit-postalcode').value = account.postalCode || '';
                document.getElementById('edit-address').value = account.address || '';
                populateEditNotes(account.notes.map(note => ({ ...note, isNew: false })));
                populateEditCustomData(account.customData.map(data => ({ ...data, isNew: false })));
                editAccountModal.style.display = 'block';
                trackChanges('edit');
            }
            
            window.openEditModal = openEditModal;
            
            editAccountForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const account = accounts.find(acc => acc.id === currentEditingAccountId);
                if (account) {
                    const changes = updateAccount(account);
                    if (changes.length > 0) {
                        const today = new Date().toISOString().split('T')[0];
                        changes.forEach(change => {
                            account.notes.push({
                                date: today,
                                content: change,
                                visible: false
                            });
                        });
                    }
                }
                editAccountModal.style.display = 'none';
                setupFilterOptions();
                filterData();
                showNotification(`アカウントを更新しました: ${account.account}`);
                resetFormStyles('edit');
            });

            function updateAccount(account) {
                const changes = [];
                const fields = [
                    { id: 'edit-account', key: 'account', label: 'サービス名' },
                    { id: 'edit-status', key: 'status', label: '状況' },
                    { id: 'edit-target', key: 'target', label: '対象' },
                    { id: 'edit-email', key: 'email', label: 'メールアドレス' },
                    { id: 'edit-password', key: 'password', label: 'パスワード' },
                    { id: 'edit-username', key: 'username', label: 'ユーザー（アカウント）名' },
                    { id: 'edit-birthdate', key: 'birthdate', label: '生年月日' },
                    { id: 'edit-gender', key: 'gender', label: '性別' },
                    { id: 'edit-lastname', key: 'lastName', label: '姓LastName' },
                    { id: 'edit-firstname', key: 'firstName', label: '名FirstName' },
                    { id: 'edit-prefecture', key: 'prefecture', label: '都道府県' },
                    { id: 'edit-country', key: 'country', label: '国' },
                    { id: 'edit-phone', key: 'phone', label: '電話番号' },
                    { id: 'edit-postalcode', key: 'postalCode', label: '郵便番号' },
                    { id: 'edit-address', key: 'address', label: '住所' }
                ];

                fields.forEach(field => {
                    const newValue = document.getElementById(field.id).value;
                    if (account[field.key] !== newValue) {
                        changes.push(`${field.label}を「${account[field.key]}」から「${newValue}」に変更しました`);
                        account[field.key] = newValue;
                    }
                });

                const notesContainer = document.getElementById('edit-notes-container');
                const noteItems = notesContainer.getElementsByClassName('edit-note-item');
                let newNotes = [];
                for (const item of noteItems) {
                    if (newNotes.length >= 64) {
                        showNotification('備考の上限に達しました。');
                        break;
                    }
                    const dateVal = item.querySelector('.edit-note-date').value;
                    const contentVal = item.querySelector('.edit-note-content').value;
                    const visibleVal = item.getAttribute('data-visible') !== "false";
                    if(contentVal.trim()){
                        newNotes.push({
                            date: dateVal || new Date().toISOString().split('T')[0],
                            content: contentVal,
                            visible: visibleVal
                        });
                    }
                }
                account.notes = newNotes;

                const customDataContainer = document.getElementById('edit-custom-data-container');
                const customDataItems = customDataContainer.getElementsByClassName('edit-custom-data-item');
                let newCustomData = [];
                for (const item of customDataItems) {
                    if (newCustomData.length >= 64) {
                        showNotification('カスタムデータの上限に達しました。');
                        break;
                    }
                    const labelVal = item.querySelector('.edit-custom-data-label').value;
                    const valueVal = item.querySelector('.edit-custom-data-value').value;
                    const existingData = account.customData.find(data => data.label === labelVal);
                    if (existingData && existingData.value !== valueVal) {
                        changes.push(`${labelVal}を「${existingData.value}」から「${valueVal}」に変更しました`);
                    }
                    if(labelVal.trim() && valueVal.trim()){
                        newCustomData.push({
                            id: generateRandomId(),
                            label: labelVal,
                            value: valueVal
                        });
                    }
                }
                account.customData = newCustomData;

                return changes;
            }
            
            exportJsonBtn.addEventListener('click', () => {
                const dataToExport = {
                    accounts: accounts,
                    exportDate: new Date().toISOString(),
                    exportVersion: "v2.0.0"
                };
                const jsonString = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `password-manager-export-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 0);
                showNotification('JSONファイルをエクスポートしました');
            });
            
            document.getElementById('fill-default-personal-add').addEventListener('click', () => {
                fillDefaultPersonalInfo('new');
            });
            
            document.getElementById('add-edit-note').addEventListener('click', function() {
                const container = document.getElementById('edit-notes-container');
                if (container.getElementsByClassName('edit-note-item').length >= 64) {
                    showNotification('備考の上限に達しました。');
                    return;
                }
                const noteItem = document.createElement('div');
                noteItem.className = 'edit-note-item';
                noteItem.setAttribute('data-visible', "true");
                
                const controls = document.createElement('div');
                controls.className = 'edit-note-controls';
                
                const dateInput = document.createElement('input');
                dateInput.type = 'date';
                dateInput.className = 'edit-note-date';
                dateInput.value = new Date().toISOString().split('T')[0];
                
                const toggleLabel = document.createElement('label');
                toggleLabel.className = 'toggle-switch';
                const toggleInput = document.createElement('input');
                toggleInput.type = 'checkbox';
                toggleInput.checked = true;
                toggleInput.addEventListener('change', function() {
                    noteItem.setAttribute('data-visible', toggleInput.checked ? "true" : "false");
                });
                const toggleSlider = document.createElement('span');
                toggleSlider.className = 'slider';
                toggleLabel.appendChild(toggleInput);
                toggleLabel.appendChild(toggleSlider);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'delete-note-btn btn-delete';
                deleteBtn.textContent = '削除';
                deleteBtn.addEventListener('click', function() {
                    container.removeChild(noteItem);
                });
                
                controls.appendChild(dateInput);
                controls.appendChild(toggleLabel);
                controls.appendChild(deleteBtn);
                noteItem.appendChild(controls);
                
                const contentTextarea = document.createElement('textarea');
                contentTextarea.className = 'edit-note-content';
                contentTextarea.placeholder = '備考を入力してください';
                
                noteItem.appendChild(contentTextarea);
                
                container.appendChild(noteItem);
            });

            document.getElementById('add-new-custom-data').addEventListener('click', function() {
                const container = document.getElementById('new-custom-data-container');
                if (container.getElementsByClassName('edit-custom-data-item').length >= 64) {
                    showNotification('カスタムデータの上限に達しました。');
                    return;
                }
                const dataItem = document.createElement('div');
                dataItem.className = 'edit-custom-data-item';
                
                const labelInput = document.createElement('input');
                labelInput.type = 'text';
                labelInput.className = 'edit-custom-data-label';
                labelInput.placeholder = 'ラベル名を入力';
                labelInput.setAttribute('list', 'custom-label-options');

                const valueInput = document.createElement('input');
                valueInput.type = 'text';
                valueInput.className = 'edit-custom-data-value';
                valueInput.placeholder = '値を入力';

                const controls = document.createElement('div');
                controls.className = 'edit-custom-data-controls';

                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'action-btn btn-delete';
                deleteBtn.textContent = '削除';
                deleteBtn.addEventListener('click', function() {
                    container.removeChild(dataItem);
                });

                controls.appendChild(labelInput);
                controls.appendChild(valueInput);
                controls.appendChild(deleteBtn);
                dataItem.appendChild(controls);
                
                container.appendChild(dataItem);
            });

            document.getElementById('add-edit-custom-data').addEventListener('click', function() {
                const container = document.getElementById('edit-custom-data-container');
                if (container.getElementsByClassName('edit-custom-data-item').length >= 64) {
                    showNotification('カスタムデータの上限に達しました。');
                    return;
                }
                const dataItem = document.createElement('div');
                dataItem.className = 'edit-custom-data-item';
                
                const labelInput = document.createElement('input');
                labelInput.type = 'text';
                labelInput.className = 'edit-custom-data-label';
                labelInput.placeholder = 'ラベル名を入力';
                labelInput.setAttribute('list', 'custom-label-options');

                const valueInput = document.createElement('input');
                valueInput.type = 'text';
                valueInput.className = 'edit-custom-data-value';
                valueInput.placeholder = '値を入力';

                const controls = document.createElement('div');
                controls.className = 'edit-custom-data-controls';

                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'action-btn btn-delete';
                deleteBtn.textContent = '削除';
                deleteBtn.addEventListener('click', function() {
                    container.removeChild(dataItem);
                });

                controls.appendChild(labelInput);
                controls.appendChild(valueInput);
                controls.appendChild(deleteBtn);
                dataItem.appendChild(controls);
                
                container.appendChild(dataItem);
            });

            // カスタムデータのラベル名候補を設定
            const customLabelOptions = document.createElement('datalist');
            customLabelOptions.id = 'custom-label-options';
            const labels = ["ログイン方法", "WEBログインパスワード", "取引パスワード", "支店名", "支店番号", "口座番号", "セキュリティコード", "PINコード", "暗証番号"];
            labels.forEach(label => {
                const option = document.createElement('option');
                option.value = label;
                customLabelOptions.appendChild(option);
            });
            document.body.appendChild(customLabelOptions);
        }
        
        function fillDefaultPersonalInfo(prefix) {
            document.getElementById(prefix + '-lastname').value = "山田";
            document.getElementById(prefix + '-firstname').value = "太郎";
            document.getElementById(prefix + '-birthdate').value = "1990-05-20";
            document.getElementById(prefix + '-gender').value = "男性";
            document.getElementById(prefix + '-phone').value = "090-1234-5678";
            document.getElementById(prefix + '-postalcode').value = "123-4567";
            document.getElementById(prefix + '-country').value = "日本";
            document.getElementById(prefix + '-prefecture').value = "東京都";
            document.getElementById(prefix + '-address').value = "新宿区西新宿1-1-1";
            const detailsEl = document.getElementById(prefix + '-details-personal');
            if (detailsEl) {
                detailsEl.open = true;
            }
        }

        function showNotification(message) {
            copyNotification.textContent = message;
            copyNotification.classList.add('show');
            setTimeout(() => {
                copyNotification.classList.remove('show');
            }, 2000);
        }
        
        // ランダムなIDを生成する関数
        function generateRandomId() {
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let id = '';
            for (let i = 0; i < 8; i++) {
                id += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            // Ensure the ID is unique
            while (accounts.some(account => account.id === id) || accounts.some(account => account.customData.some(data => data.id === id))) {
                id = '';
                for (let i = 0; i < 8; i++) {
                    id += chars.charAt(Math.floor(Math.random() * chars.length));
                }
            }
            return id;
        }

        // 初期化処理
        function init() {
            setupFilterOptions();
            setupAccountManagement();
            searchAccount.addEventListener('input', filterData);
            filterStatus.addEventListener('change', filterData);
            filterTarget.addEventListener('change', filterData);
            filterEmail.addEventListener('change', filterData);
            resetFiltersBtn.addEventListener('click', resetFilters);
            filterData();
        }
        
        function trackChanges(prefix) {
            const formElements = document.querySelectorAll(`#${prefix}-account-form input, #${prefix}-account-form select, #${prefix}-account-form textarea`);
            formElements.forEach(element => {
                element.addEventListener('input', () => {
                    element.classList.add('highlighted');
                });
            });
        }

        function isFormChanged(prefix) {
            const formElements = document.querySelectorAll(`#${prefix}-account-form input, #${prefix}-account-form select, #${prefix}-account-form textarea`);
            return Array.from(formElements).some(element => element.classList.contains('highlighted'));
        }

        function resetFormStyles(prefix) {
            const formElements = document.querySelectorAll(`#${prefix}-account-form input, #${prefix}-account-form select, #${prefix}-account-form textarea`);
            formElements.forEach(element => {
                element.classList.remove('highlighted');
            });
        }
        
        init();
    </script>
</body>
</html>